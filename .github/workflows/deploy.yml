name: Deploy to cPanel

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: website/package-lock.json

    - name: Install Dependencies
      run: |
        cd website
        npm ci

    - name: Build Application
      run: |
        cd website
        npm run build

    - name: Remove node_modules (to avoid uploading dev dependencies)
      run: rm -rf website/node_modules

    - name: Deploy Files via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        # Upload only necessary files for production
        source: "website/.next,website/public,website/package.json,website/server.js,website/prisma,website/next.config.mjs"
        target: "/home/${{ secrets.SSH_USERNAME }}/dawar-app"
        # Remove the 'website/' prefix so files land directly in dawar-app
        strip_components: 1
        # Overwrite existing files
        overwrite: true

    - name: Install Dependencies & Restart Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          # Load NVM (Node Version Manager)
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          # Ensure Node 20 is installed and used
          nvm install 20
          nvm use 20
          nvm alias default 20
          
          # Navigate to app directory
          cd /home/${{ secrets.SSH_USERNAME }}/dawar-app
          
          # Install production dependencies
          npm install --production
          
          # Run Database Migrations
          npx prisma migrate deploy
          
          # Restart Application with PM2
          pm2 restart dawar-website || pm2 start server.js --name "dawar-website"
          pm2 save
